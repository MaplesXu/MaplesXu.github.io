<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
    <title>LaTeX Â· æ¸²æŸ“å™¨</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$','$'], ['\\(','\\)']],
                displayMath: [['$$','$$'], ['\\[','\\]']],
                processEscapes: true
            },
            options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] },
            loader: { load: ['[tex]/noerrors'] },
            chtml: { fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2' }
        };
    </script>
    <script src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-chtml.js"
            id="MathJax-script"
            async
            onerror="this.onerror=null; let s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js'; document.head.appendChild(s);">
    </script>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            background:#e2ecf0;
            font-family:Inter, sans-serif;
            display:flex;
            justify-content:center;
            align-items:center;
            min-height:100vh;
            padding:16px;
            transition:background .15s;
        }
        .app{
            max-width:950px;
            width:100%;
            background:white;
            border-radius:24px;
            box-shadow:0 16px 30px -10px #1b4a5a30;
            padding:24px 28px;
            border:1px solid #cfe1e9;
        }
        h1{
            font-size:1.6rem;
            font-weight:550;
            color:#0b4452;
            margin-bottom:6px;
        }
        .input-box{
            background:#f6fcff;
            border-radius:20px;
            padding:18px;
            border:1px solid #cfe1e9;
            margin-bottom:16px;
        }
        .input-header{
            display:flex;
            justify-content:space-between;
            font-size:0.9rem;
            font-weight:600;
            color:#0e5563;
            margin-bottom:10px;
        }
        textarea{
            width:100%;
            padding:16px 18px;
            border:1px solid #bfd7e2;
            border-radius:18px;
            font-family:'JetBrains Mono',monospace;
            font-size:0.9rem;
            line-height:1.6;
            background:white;
            resize:vertical;
        }
        textarea:focus{
            border-color:#318ca0;
            outline:none;
            box-shadow:0 0 0 2px #318ca030;
        }
        .toolbar{
            display:flex;
            flex-wrap:wrap;
            justify-content:center;
            gap:16px;
            margin:12px 0 8px;
        }
        .btn{
            border:none;
            background:#1d6d7c;
            color:white;
            padding:10px 26px;
            border-radius:36px;
            font-weight:600;
            font-size:0.95rem;
            display:inline-flex;
            align-items:center;
            gap:8px;
            cursor:pointer;
            border:1px solid #ffffff80;
            box-shadow:0 6px 12px -8px #0c4a55;
            transition:0.1s;
        }
        .btn:hover{
            background:#2a889b;
            transform:scale(0.97);
        }
        .btn-outline{
            background:white;
            color:#1a6b78;
            border:1px solid #3993a8;
            box-shadow:none;
        }
        .btn-outline:hover{
            background:#ecf8fc;
        }
        .render-header{
            display:flex;
            justify-content:space-between;
            margin:22px 0 10px;
        }
        .render-title{
            font-weight:600;
            color:#0a5a67;
        }
        .render-area{
            background:#faffff;
            border-radius:20px;
            padding:24px 28px;
            border:1px solid #c0dbe6;
            overflow-x:auto;
            font-size:1.2rem;
            line-height:2;
            min-height:150px;
            font-family:Inter, sans-serif;
            transition:background .15s;
        }
        
        body.dark-mode{
            background:#0f262e;
            color:#ffffff !important;
        }
        body.dark-mode .app{
            background:#1f404a;
            border-color:#2c6573;
            color:#ffffff !important;
        }
        body.dark-mode .input-box,
        body.dark-mode .render-area{
            background:#1f454e;
            border-color:#2a6a7a;
            color:#ffffff !important;
        }
        body.dark-mode textarea{
            background:#2a5663;
            color:#ffffff !important;
            border-color:#3f8b9c;
        }
        body.dark-mode textarea::placeholder{
            color:#cce7ed;
        }
        body.dark-mode h1,
        body.dark-mode .input-header,
        body.dark-mode .render-title,
        body.dark-mode .sidebar-item label,
        body.dark-mode .sidebar-header h3,
        body.dark-mode .sidebar-header span{
            color:#ffffff !important;
        }
        body.dark-mode .btn{
            background:#2d7a8c;
            color:white !important;
            border-color:#aad4df;
        }
        body.dark-mode .btn-outline{
            background:transparent;
            color:white !important;
            border-color:#7fc1d0;
        }
        body.dark-mode .btn-outline:hover{
            background:#357e8f;
        }
        body.dark-mode .settings-sidebar{
            background:#1f404a;
            border-left-color:#3c7e8c;
            color:#ffffff !important;
        }
        body.dark-mode select,
        body.dark-mode input[type="range"]{
            background:#2d616e;
            color:white !important;
            border-color:#8dcbd6;
        }
        body.dark-mode option{
            background:#1f404a;
            color:white;
        }
        body.dark-mode .render-area mjx-container{
            color:#ffffff !important;
        }
        body.dark-mode .render-area.fullscreen-active{
            background:#1f454e;
        }

        .sidebar-toggle-btn{
            position:fixed;
            top:20px;
            right:20px;
            width:48px;
            height:48px;
            background:#1f6573;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-size:26px;
            cursor:pointer;
            z-index:1001;
            border:2px solid #ffffffcc;
        }
        .settings-sidebar{
            position:fixed;
            top:0;
            right:0;
            width:280px;
            height:100vh;
            background:white;
            box-shadow:-6px 0 20px #143c46;
            padding:28px 20px;
            z-index:1000;
            transform:translateX(100%);
            transition:transform .2s;
            border-left:1px solid #cfe1e9;
            overflow-y:auto;
        }
        .settings-sidebar.active{
            transform:translateX(0);
        }
        .sidebar-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:28px;
        }
        .close-sidebar{
            font-size:28px;
            cursor:pointer;
            padding:0 8px;
            color:#1f6573;
        }
        .sidebar-item{
            margin-bottom:24px;
            display:flex;
            flex-direction:column;
            gap:8px;
        }
        .sidebar-item label{
            font-weight:600;
            color:#0b4452;
        }
        select,input[type=range]{
            padding:8px 12px;
            border-radius:30px;
            border:1px solid #96c0cc;
            background:white;
        }
        
        @media print {
            .app > *:not(#mathContainer):not(.render-area) {
                display: none !important;
            }
            .input-box, .toolbar, .render-header, 
            .sidebar-toggle-btn, .settings-sidebar, 
            h1, .sub, .badge, hr, .status-line,
            .btn, .btn-outline {
                display: none !important;
            }
            
            body, body.dark-mode {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                display: block !important;
            }
            
            .app {
                background: transparent !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
            }
            
            .render-area {
                border: none !important;
                box-shadow: none !important;
                padding: 1.5cm !important;
                background: white !important;
                color: black !important;
                font-size: 12pt !important;
                line-height: 1.8 !important;
                font-family: Inter, sans-serif !important;
                margin: 0 auto !important;
                width: 100% !important;
                min-height: auto !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
            }
            
            .render-area mjx-container {
                color: black !important;
            }
            
            .render-area, body, .app {
                background: white !important;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <h1>LaTeXÂ·æ¸²æŸ“å™¨</h1>
        <div class="input-box">
            <div class="input-header"><span>ğŸ“‹ æºç </span></div>
            <textarea id="latexInput" rows="4">\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}</textarea>
        </div>
        <div class="toolbar">
            <button class="btn" id="renderBtn">âš¡ æ¸²æŸ“</button>
            <button class="btn btn-outline" id="fullscreenBtn">ğŸ“º å…¨å±</button>
            <button class="btn btn-outline" id="pdfBtn">ğŸ“„ PDF</button>
        </div>
        <div class="render-header"><span class="render-title">âœ¨ è¾“å‡º</span></div>
        <div id="mathContainer" class="render-area"></div>
    </div>
    <div class="sidebar-toggle-btn" id="sidebarToggleBtn">âš™ï¸</div>
    <div class="settings-sidebar" id="settingsSidebar">
        <div class="sidebar-header">
            <h3 style="margin:0">ğŸ› ï¸ è®¾ç½®</h3>
            <span class="close-sidebar" id="closeSidebarBtn">âœ•</span>
        </div>
        <div class="sidebar-item">
            <label>ğŸ–‹ï¸ å­—ä½“</label>
            <select id="fontSelect">
                <option value="Inter, sans-serif">æ— è¡¬çº¿</option>
                <option value="Times New Roman, serif">è¡¬çº¿</option>
                <option value="JetBrains Mono, monospace">ç­‰å®½</option>
            </select>
        </div>
        <div class="sidebar-item">
            <label>ğŸ”  å­—å· <span id="fontSizeLabel">1.2rem</span></label>
            <input type="range" id="fontSizeSlider" min="0.8" max="1.8" step="0.05" value="1.2">
        </div>
        <div class="sidebar-item">
            <label>ğŸ“ è¡Œè· <span id="lineHeightLabel">2.0</span></label>
            <input type="range" id="lineHeightSlider" min="1.2" max="2.8" step="0.1" value="2.0">
        </div>
        <div class="sidebar-item">
            <label>ğŸŒ“ ä¸»é¢˜</label>
            <div style="display:flex;flex-direction:column;gap:8px;">
                <label style="font-weight:normal"><input type="radio" name="themeMode" value="auto" checked> è·Ÿéšç³»ç»Ÿ</label>
                <label style="font-weight:normal"><input type="radio" name="themeMode" value="light"> äº®è‰²</label>
                <label style="font-weight:normal"><input type="radio" name="themeMode" value="dark"> æš—è‰²</label>
            </div>
        </div>
    </div>
    <script>
        (function(){
            "use strict";

            const inputEl = document.getElementById('latexInput');
            const container = document.getElementById('mathContainer');
            const renderBtn = document.getElementById('renderBtn');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const pdfBtn = document.getElementById('pdfBtn');
            const sidebar = document.getElementById('settingsSidebar');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const closeBtn = document.getElementById('closeSidebarBtn');
            const fontSelect = document.getElementById('fontSelect');
            const fontSizeSlider = document.getElementById('fontSizeSlider');
            const lineHeightSlider = document.getElementById('lineHeightSlider');
            const fontSizeLabel = document.getElementById('fontSizeLabel');
            const lineHeightLabel = document.getElementById('lineHeightLabel');

            let lastRenderedSource = '';
            let isMathJaxReady = false;
            let renderTimer = null;
            let pendingRender = false;

            const escapeHtml = (s) => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[c]);

            function autoWrapDelimiters(text) {
                if (!text) return '';
                const hasDelim = /[$]|\\[()[\]]|\$\$/.test(text);
                const looksLikeLatex = /\\[a-zA-Z]+|[_\^]/.test(text);
                if (!hasDelim && looksLikeLatex) {
                    return text.split('\n').map(line => {
                        const trimmed = line.trim();
                        if (trimmed && !/[$]|\\[()[\]]|\$\$/.test(line) && /\\[a-zA-Z]+|[_\^]/.test(line)) {
                            return '$' + line + '$';
                        }
                        return line;
                    }).join('\n');
                }
                return text;
            }

            function renderNow() {
                const source = inputEl.value;
                lastRenderedSource = source;

                const processed = autoWrapDelimiters(source);
                const lines = processed.split('\n');
                let html = '';
                for (let line of lines) {
                    if (line.trim() === '') html += '<br>';
                    else html += `<p style="margin:0.6rem 0;">${escapeHtml(line)}</p>`;
                }
                container.innerHTML = html;

                if (window.MathJax && MathJax.texReset && MathJax.typesetPromise) {
                    MathJax.texReset();
                    return MathJax.typesetPromise([container]).catch(err => {
                        console.warn('å…¬å¼æ¸²æŸ“é”™è¯¯:', err);
                        container.innerHTML += '<p style="color:#b34a4a;">âš ï¸ LaTeX è¯­æ³•é”™è¯¯</p>';
                    });
                } else {
                    return Promise.reject('MathJax æœªå°±ç»ª');
                }
            }

            function smartRender(force = false) {
                const source = inputEl.value;
                if (!force && source === lastRenderedSource) {
                    return Promise.resolve();
                }
                return renderNow();
            }

            function debouncedRender(force = false) {
                if (renderTimer) clearTimeout(renderTimer);
                if (force) {
                    smartRender(true);
                } else {
                    renderTimer = setTimeout(() => smartRender(false), 250);
                }
            }

            function waitForMathJax() {
                if (window.MathJax && MathJax.texReset && MathJax.typesetPromise) {
                    isMathJaxReady = true;
                    renderNow().catch(e => console.warn('é¦–æ¬¡æ¸²æŸ“å¤±è´¥', e));
                } else {
                    setTimeout(waitForMathJax, 50);
                }
            }

            const systemDark = window.matchMedia('(prefers-color-scheme: dark)');
            
            function setCookie(name, value, days) {
                const d = new Date();
                d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + d.toUTCString() + ";path=/;SameSite=Lax";
            }

            function getCookie(name) {
                const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                return match ? decodeURIComponent(match[2]) : null;
            }

            function saveSettingsToCookie() {
                const settings = {
                    font: fontSelect.value,
                    fontSize: fontSizeSlider.value,
                    lineHeight: lineHeightSlider.value,
                    theme: document.querySelector('input[name="themeMode"]:checked')?.value || 'auto'
                };
                setCookie('latexRendererSettings', JSON.stringify(settings), 365);
            }

            function loadSettingsFromCookie() {
                const cookie = getCookie('latexRendererSettings');
                if (cookie) {
                    try {
                        const settings = JSON.parse(cookie);
                        if (settings.font) {
                            const optionExists = Array.from(fontSelect.options).some(opt => opt.value === settings.font);
                            if (optionExists) fontSelect.value = settings.font;
                        }
                        if (settings.fontSize) fontSizeSlider.value = settings.fontSize;
                        if (settings.lineHeight) lineHeightSlider.value = settings.lineHeight;
                        if (settings.theme) {
                            const radio = document.querySelector(`input[name="themeMode"][value="${settings.theme}"]`);
                            if (radio) radio.checked = true;
                        }
                    } catch (e) {}
                }
            }

            loadSettingsFromCookie();

            function applyTheme() {
                const mode = document.querySelector('input[name="themeMode"]:checked')?.value || 'auto';
                const isDark = mode === 'dark' || (mode === 'auto' && systemDark.matches);
                document.body.classList.toggle('dark-mode', isDark);
                saveSettingsToCookie();
            }
            
            systemDark.addEventListener('change', () => {
                applyTheme();
                saveSettingsToCookie();
            });
            
            document.querySelectorAll('input[name="themeMode"]').forEach(r => {
                r.addEventListener('change', () => {
                    applyTheme();
                    saveSettingsToCookie();
                });
            });

            toggleBtn.addEventListener('click', () => sidebar.classList.toggle('active'));
            closeBtn.addEventListener('click', () => sidebar.classList.remove('active'));
            document.addEventListener('click', (e) => {
                if (sidebar.classList.contains('active') && !sidebar.contains(e.target) && e.target !== toggleBtn) {
                    sidebar.classList.remove('active');
                }
            });

            function applyStyle() {
                container.style.fontFamily = fontSelect.value;
                container.style.fontSize = fontSizeSlider.value + 'rem';
                container.style.lineHeight = lineHeightSlider.value;
            }

            fontSelect.addEventListener('change', () => {
                applyStyle();
                smartRender(true);
                saveSettingsToCookie();
            });
            fontSizeSlider.addEventListener('input', function() {
                fontSizeLabel.textContent = this.value + 'rem';
                applyStyle();
                saveSettingsToCookie();
            });
            lineHeightSlider.addEventListener('input', function() {
                lineHeightLabel.textContent = this.value;
                applyStyle();
                saveSettingsToCookie();
            });

            fontSizeLabel.textContent = fontSizeSlider.value + 'rem';
            lineHeightLabel.textContent = lineHeightSlider.value;
            applyStyle();

            function exportPDF() {
                smartRender(true).finally(() => {
                    requestAnimationFrame(() => {
                        window.print();
                    });
                });
            }

            function toggleFullScreen() {
                if (!document.fullscreenElement) {
                    container.requestFullscreen().catch(console.warn);
                } else {
                    document.exitFullscreen();
                }
            }

            renderBtn.addEventListener('click', () => smartRender(true));
            fullscreenBtn.addEventListener('click', toggleFullScreen);
            pdfBtn.addEventListener('click', exportPDF);

            inputEl.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    smartRender(true);
                }
            });

            inputEl.addEventListener('input', () => debouncedRender(false));

            applyTheme();
            
            waitForMathJax();
        })();
    </script>
</body>
</html>